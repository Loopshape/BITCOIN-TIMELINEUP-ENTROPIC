// BIP39 wordlist for English
const WORDLIST = "abandon,ability,able,about,above,absent,absorb,abstract,absurd,abuse,access,accident,account,accuse,achieve,acid,acoustic,acquire,across,act,action,actor,actress,actual,adapt,add,addict,address,adjust,admit,adult,advance,advice,aerobic,affair,affect,afford,afraid,again,age,agent,agree,ahead,aim,air,airport,aisle,alarm,album,alcohol,alert,alien,all,alley,allow,almost,alone,alpha,already,also,alter,always,amateur,amazing,among,amount,amused,analyst,ancestor,anchor,ancient,anger,angle,angry,animal,ankle,announce,annual,another,answer,antenna,antique,anxiety,any,apart,apology,appear,apple,approve,april,arch,arctic,area,arena,argue,arm,armed,armor,army,around,arrange,arrest,arrive,arrow,art,artefact,artist,artwork,ask,aspect,assault,asset,assist,assume,asthma,athlete,atom,attack,attend,attitude,attract,auction,audit,august,aunt,author,auto,autumn,average,avocado,avoid,awake,aware,away,awesome,awful,awkward,axis,baby,bachelor,bacon,badge,bag,balance,balcony,ball,bamboo,banana,banner,bar,barely,bargain,barrel,base,basic,basket,battle,beach,bean,beauty,because,become,beef,before,begin,behave,behind,believe,below,benefit,best,betray,better,between,beyond,bicycle,bid,bike,bind,biology,bird,birth,bitter,black,blade,blame,blanket,blast,bleak,bless,blind,blood,blossom,blouse,blue,blur,blush,board,boat,body,boil,bomb,bone,bonus,book,boost,border,boring,borrow,boss,bottom,bounce,box,boy,bracket,brain,brand,brass,brave,bread,breeze,brick,bridge,brief,bright,bring,brittle,broadcast,broker,bronze,brother,brown,brush,bubble,budget,buffalo,build,bulb,bulk,bullet,bundle,burden,burger,burst,bus,business,busy,butter,buyer,buzz,cabbage,cabin,cable,cactus,cage,cake,call,calm,camera,camp,can,canal,cancel,candy,cannon,canoe,canvas,canyon,capable,capital,captain,car,carbon,card,care,cargo,carpet,carry,cart,case,cash,casino,castle,casual,cat,catalog,catch,category,cattle,caught,cause,caution,cave,cease,ceiling,celery,cement,census,century,cereal,certain,chair,chalk,champion,change,chaos,chapter,charge,chase,chat,cheap,check,cheese,chef,cherry,chest,chicken,chief,child,chimney,choice,choose,chronic,chuckle,chunk,churn,cigar,cinnamon,circle,citizen,city,civil,claim,clap,clarify,claw,clean,clerk,clever,click,client,cliff,climb,clinic,clip,clock,clog,clone,close,cloth,cloud,clown,club,clump,cluster,clutch,coach,coast,coconut,code,coffee,coil,coin,collect,color,column,combine,come,comfort,comic,common,company,compete,complete,complex,concrete,confirm,congress,connect,consider,control,convince,cook,cool,copper,copy,coral,core,corn,correct,cost,cotton,couch,country,couple,course,cousin,cover,coyote,crack,cradle,craft,cram,crane,crash,crater,crawl,crazy,cream,credit,creek,crew,crisp,critic,crop,cross,crouch,crowd,crucial,cruel,cruise,crumble,crunch,crush,cry,crystal,cube,culture,cup,cupboard,curious,current,curtain,curve,cushion,custom,cute,cycle,dad,damage,damp,dance,danger,daring,dash,daughter,dawn,day,deal,debate,decade,december,decide,decline,decorate,decrease,deer,defense,define,defy,degree,delay,deliver,demand,demise,denial,dentist,deny,depart,depend,deposit,depth,deputy,derive,describe,desert,design,desk,despair,destroy,detail,detect,develop,device,devote,diagram,dial,diamond,diary,dice,diesel,diet,differ,digital,dignity,dilemma,dinner,dinosaur,direct,dirt,disagree,discover,disease,dish,dismiss,disorder,display,distance,divert,divide,divorce,dizzy,doctor,document,dog,doll,dolphin,domain,donate,donkey,donor,door,dose,double,dove,draft,dragon,drama,drastic,draw,dream,dress,drift,drill,drink,drip,drive,drop,drum,dry,duck,dumb,dune,during,dust,dutch,duty,dwarf,dynamic,eager,eagle,early,earn,earth,easily,east,easy,echo,ecology,economy,edge,edit,educate,effort,egg,eight,either,elbow,elder,electric,elegant,element,elephant,elevator,elite,else,embark,embody,embrace,emerge,emotion,employ,empower,empty,enable,enact,end,endless,endorse,enemy,energy,enforce,engage,engine,enhance,enjoy,enlist,enough,enrich,enroll,ensure,enter,entire,entry,envelope,episode,equal,equip,era,erase,erode,erosion,error,erupt,escape,essay,essence,estate,eternal,ethics,evidence,evil,evoke,evolve,exact,example,exchange,excite,exclude,excuse,execute,exercise,exhaust,exhibit,exile,exist,exit,exotic,expand,expect,expire,explain,expose,express,extend,extra,eye,eyebrow,fabric,face,faculty,fade,faint,fair,faith,fall,family,famous,fan,fancy,farewell,farm,fashion,fat,fatal,father,fatigue,fault,favorite,feature,february,federal,fee,feed,feel,female,fence,festival,fetch,fever,few,fiber,fiction,field,figure,file,film,filter,final,find,fine,finger,finish,fire,firm,first,fiscal,fish,fit,fitness,five,fix,flag,flame,flash,flat,flavor,flee,flight,flip,float,flock,floor,flower,fluid,flush,fly,foam,focus,fog,foil,fold,follow,food,foot,force,forest,forget,fork,fortune,forum,forward,fossil,foster,found,four,fox,fragile,frame,frequent,fresh,friend,fringe,frog,front,frost,frown,frozen,fruit,fuel,fun,funny,furnace,fury,future,gadget,gain,galaxy,gallery,game,gap,garage,garbage,garden,garlic,garment,gas,gasp,gate,gather,gauge,gaze,general,genius,genre,gentle,genuine,gesture,ghost,giant,gift,giggle,ginger,giraffe,girl,give,glad,glance,glass,glimpse,glory,glove,glow,glue,go,goal,god,goddess,gold,golem,gong,good,goose,gorgeous,gossip,govern,go,gospel,gossip,govern,grab,grace,grain,grant,grape,grass,gravity,great,green,grid,grief,grit,grocery,group,grow,grunt,guard,guess,guide,guilt,guitar,gun,gym,habit,hair,half,hammer,hamster,hand,happy,harbor,hard,harsh,harvest,hat,have,hawk,hazard,head,health,heart,heavy,hedgehog,height,hello,helmet,help,hemp,hero,hew,hike,hill,hip,hippie,history,hit,hive,hobbit,hobby,hockey,hold,hole,holiday,home,honey,hook,hope,horizon,horse,hospital,host,hotel,hour,hover,howl,hub,hug,huge,human,humble,humor,hungry,hunt,hurdle,hurt,husband,hybrid,ice,icon,idea,identify,idle,ignite,ignore,ill,illegal,illness,image,imitate,immense,immune,impact,impose,improve,impulse,in,inbox,inch,include,income,increase,index,indicate,indoor,industry,infant,inflict,inform,inhale,inherit,initial,inject,injure,inside,install,intense,interest,internal,intimate,into,invoke,involve,iron,is,island,isolate,issue,item,ivory,jacket,jaguar,jar,jazz,jealous,jeans,jelly,jewelry,job,join,joke,journey,joy,judge,juice,jungle,junior,junk,just,kangaroo,keep,ketchup,key,kick,kid,kidney,kind,kingdom,kiss,kit,kitchen,kite,kitten,kiwi,knee,knife,knight,knock,know,lab,label,labor,lace,ladder,lady,lake,lamp,language,large,last,late,later,latin,laugh,laundry,lava,law,lawn,lawsuit,lazy,leaf,learn,leave,lecture,left,leg,legal,lemon,lend,length,lens,leopard,lesson,let,letter,level,liar,liberty,library,license,life,light,like,limb,limit,line,lion,liquid,list,little,live,lizard,load,loan,lobby,lobster,local,lock,logic,lonely,long,loop,lottery,loud,lounge,love,loyal,lucky,luggage,lumber,lunar,lunch,luxury,lyric,machine,mad,magic,magnet,magnify,main,major,make,mammal,manage,mandate,mango,mansion,manual,maple,marble,march,margin,marine,market,mask,mass,master,match,material,math,matrix,matter,maximum,maze,meadow,mean,measure,meat,mechanic,medal,media,melody,melt,member,memory,menu,mercy,merge,message,metal,method,middle,midnight,milk,minimum,minor,minute,miracle,mirror,misery,miss,mistake,mix,mixed,mixture,mobile,model,modify,mom,moment,monitor,monkey,monster,month,moon,moral,more,morning,mosquito,mother,motion,motor,mountain,mouse,move,movie,much,muffin,mule,multiple,muscle,museum,mushroom,music,must,my,mystic,myth,naive,name,napkin,narrow,nasty,nation,nature,near,neck,need,negotiate,neighbor,neither,nerve,nest,net,network,neutral,never,new,next,nice,night,ninja,ninth,noodle,normal,north,nose,notable,note,nothing,notice,novel,now,nuclear,number,nurse,nut,oath,obey,object,oblige,obvious,occupy,ocean,october,odor,off,offer,office,oil,okay,old,olive,omni,on,once,one,only,open,opera,opinion,oppose,option,orange,orbit,orchard,order,ordinary,organ,orient,original,orphan,osprey,other,our,out,outdoor,outer,output,outside,oval,oven,over,own,owner,oxygen,oyster,ozone,pact,page,pair,palace,palm,panda,panel,panic,paper,parade,parent,park,parrot,party,pass,patch,path,patient,patrol,pattern,pause,pave,payment,peace,peanut,peasant,pelican,pen,penalty,pencil,people,pepper,perfect,perfume,perceive,permit,person,pet,phone,photo,phrase,physical,piano,picnic,picture,piece,pig,pill,pilot,pine,pink,pioneer,pipe,pistol,pitch,pizza,place,planet,plastic,plate,play,please,pledge,pluck,plug,plunge,poem,poet,point,polar,pole,police,policy,poll,pollen,pond,pony,pool,pop,popular,portion,position,possible,post,pot,pouch,poverty,powder,power,practice,praise,predict,prefer,prepare,present,pretty,prevent,price,pride,primary,print,priority,prison,private,prize,process,produce,profit,program,project,promote,proof,property,prosper,protect,proud,provide,prune,public,pudding,pull,pulp,pulse,pumpkin,punch,pupil,puppy,purchase,purity,purpose,push,put,puzzle,pyramid,quality,quantum,quarter,question,quick,quit,quiz,quote,rabbit,race,rack,radar,radio,rail,rain,raise,rally,ramp,range,rank,rapid,rare,rate,rather,raven,raw,razor,ready,real,reason,rebel,receive,recharge,record,recycle,reduce,reform,refuse,regret,regular,rehab,reign,relax,release,relief,rely,remain,remember,remind,remove,render,renew,rent,repair,repeat,replace,report,require,rescue,resemble,resist,resource,response,result,retire,retreat,return,reunion,reveal,review,reward,rhythm,rice,rich,ridge,rifle,right,rigid,ring,riot,ripple,risk,ritual,rival,river,road,roast,robot,robust,rocket,rodeo,roger,roll,roof,room,rose,rotate,round,route,royal,rubber,rude,rug,rule,run,runway,rural,sad,saddle,safe,sail,salad,salmon,salon,salt,same,sample,sand,satisfy,satoshi,sauce,sausage,save,say,scale,scan,scare,scatter,scene,scheme,school,science,scissors,scorpion,scout,scrap,screen,script,scrub,sea,search,season,seat,second,secret,section,security,see,seed,seek,segment,select,sell,seminar,senior,sense,sentence,series,service,session,set,settle,setup,seven,shadow,shaft,shallow,share,shed,shell,sheriff,shield,shiver,shock,shoe,shoot,shop,short,shoulder,shove,shrimp,shrug,shuffle,shy,sibling,sick,side,sidewalk,sight,sign,silent,silk,silly,silver,similar,simple,since,sing,siren,sister,six,size,skate,sketch,ski,skill,skin,skirt,skull,slab,slam,sleep,slender,slice,slide,slim,slogan,slot,slush,small,smart,smile,smoke,smooth,snack,snake,snap,sniff,snow,soap,soccer,social,sock,soda,soft,solar,soldier,solo,solution,solve,someone,song,soon,sorry,sort,sound,soup,source,south,space,spare,spatial,speak,special,speed,spell,spend,sphere,spice,spider,spike,spin,spirit,split,spoil,sponsor,spoon,sport,spot,spray,spread,spring,spy,square,squeeze,squirrel,stable,stadium,staff,stage,stamp,stand,start,state,stay,steak,steel,stem,step,stereo,stick,still,sting,stock,stomach,stone,stool,story,stove,strategy,street,strike,strong,struggle,student,stuff,stumble,style,subject,subway,success,such,sudden,suffer,sugar,suggest,suit,summer,sun,sunny,sunset,super,supply,support,sure,surface,surge,surprise,surround,survey,suspect,sustain,swallow,swamp,swear,sweet,swift,swim,swing,switch,sword,symbol,symptom,syrup,system,table,tackle,tag,tail,talent,talk,tank,task,taste,tattoo,tax,teach,team,tell,ten,tenant,tennis,tent,term,test,text,thank,that,theme,then,theory,there,they,thing,this,thought,three,thrive,throw,thumb,thunder,ticket,tide,tiger,tilt,timber,time,tiny,tip,tired,tissue,title,toast,tobacco,today,toddler,toe,together,toilet,token,tomato,tomorrow,tone,tongue,tonight,tool,tooth,top,topic,topple,torch,tornado,tortoise,toss,total,tourist,toward,tower,town,toy,trace,track,trade,traffic,tragedy,train,transfer,trap,travel,tray,treat,tree,trend,trial,tribe,trick,trigger,trim,trip,trophy,trouble,truck,true,truly,trust,truth,try,tube,tuition,tumble,tuna,tunnel,turkey,turn,turtle,twelve,twenty,twice,twin,twist,two,type,typical,ugly,umbrella,unable,uncover,under,undo,unfold,unhappy,uniform,unique,unit,universe,unknown,unusual,unveil,update,upload,upset,urban,urge,us,usage,use,used,useful,usher,usual,utility,vacant,vacuum,vague,valid,valley,valve,van,vanish,vapor,various,vast,vault,vehicle,velvet,vendor,venture,venue,verb,verify,version,very,vessel,veteran,viable,vibrant,vicious,victory,video,view,village,vintage,violin,virtual,virus,visa,visit,visual,vital,vivid,vocal,voice,void,volcano,volume,vote,voyage,wage,wagon,wait,walk,wall,walnut,want,war,warm,warning,wash,wasp,waste,water,wave,way,we,wear,weasel,weather,web,wedding,weekend,weird,welcome,west,wet,whale,what,wheat,wheel,when,where,whip,whisper,wide,width,wife,wild,will,win,window,wine,wing,wink,winner,winter,wire,wisdom,wise,wish,witness,wolf,woman,wonder,wood,wool,word,work,world,worry,worth,wrap,wreck,wrestle,wrist,write,wrong,yard,year,yellow,you,young,youth,zebra,zero,zone,zoo";
const WORDLIST_ARRAY = WORDLIST.split(',');
let currentEntropyHex = '';

// Function to update all displayed values
async function updateValues() {
    // Get current timestamp in MMDDYYHHMMSS format
    const now = new Date();
    const timestamp = [
        String(now.getMonth() + 1).padStart(2, '0'),
        String(now.getDate()).padStart(2, '0'),
        String(now.getFullYear()).slice(-2),
        String(now.getHours()).padStart(2, '0'),
        String(now.getMinutes()).padStart(2, '0'),
        String(now.getSeconds()).padStart(2, '0')
    ].join('');

    // Display timestamp
    document.getElementById('timestamp')!.textContent = timestamp;

    // Generate SHA-256 hash from the timestamp
    const hash = await sha256(timestamp);
    document.getElementById('hash')!.textContent = hash.slice(0, 4) + '...' + hash.slice(-4);

    // Get 64-bit (16-character) entropy from the hash
    const entropyHex = hash.slice(0, 16);
    currentEntropyHex = entropyHex;
    document.getElementById('entropy')!.textContent = `0x${entropyHex.toUpperCase()}`;

    // Calculate and display entropy strength
    const strength = calculateEntropyStrength(entropyHex);
    const strengthBar = document.getElementById('strength-meter-bar') as HTMLDivElement;
    const strengthValue = document.getElementById('strength-value');
    
    if (strengthBar && strengthValue) {
        strengthBar.style.width = `${strength}%`;
        strengthValue.textContent = `${strength.toFixed(1)}%`;

        // Update color based on strength
        strengthBar.classList.remove('strength-strong', 'strength-medium', 'strength-weak');
        if (strength > 80) {
            strengthBar.classList.add('strength-strong');
        } else if (strength > 50) {
            strengthBar.classList.add('strength-medium');
        } else {
            strengthBar.classList.add('strength-weak');
        }
    }

    // Generate BIP39 mnemonic from a 128-bit hash slice
    const mnemonicEntropy = hash.slice(0, 32); // Use 128 bits for a 12-word mnemonic
    const mnemonic = generateBIP39Mnemonic(mnemonicEntropy);
    document.getElementById('mnemonic')!.textContent = mnemonic;

    // Generate a dynamic Satoshi value
    const entropyDec = parseInt(entropyHex, 16);
    const satsValue = (entropyDec % 100000) + 1000;
    document.getElementById('sats')!.textContent = `${satsValue} sats`;
    
    // Base58Check is complex; for this demo, we use a placeholder.
    const base58Placeholder = "1" + hash.slice(0, 32);
    document.getElementById('base58')!.textContent = base58Placeholder;
}

// Calculates entropy strength based on bit distribution (1s vs 0s)
function calculateEntropyStrength(entropyHex: string): number {
    if (entropyHex.length !== 16) return 0; // Expects 64 bits / 16 hex chars

    let bitCount = 0;
    for (const char of entropyHex) {
        const binary = parseInt(char, 16).toString(2).padStart(4, '0');
        for (const bit of binary) {
            if (bit === '1') {
                bitCount++;
            }
        }
    }

    // Ideal bit count is 32 for a 64-bit string.
    // Max deviation is 32 (all 0s or all 1s).
    const deviation = Math.abs(bitCount - 32);
    const strength = (1 - (deviation / 32)) * 100;
    
    return strength;
}

// Real SHA-256 cryptographic hash function using Web Crypto API
async function sha256(data: string): Promise<string> {
    const msgBuffer = new TextEncoder().encode(data);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    return hashHex;
}

// Generates a 12-word BIP39 mnemonic from 128 bits (32 hex chars) of entropy.
function generateBIP39Mnemonic(entropyHex: string): string {
    // This function requires a proper crypto library for the checksum.
    // The provided logic is a simplified placeholder for demonstration.
    if (entropyHex.length !== 32) {
      return "Invalid entropy length for 12-word mnemonic.";
    }

    const entropyBytes = hexToBytes(entropyHex);
    
    // Simplified checksum. A real implementation MUST use the first 4 bits of a SHA-256 hash of the entropy.
    const checksum = (entropyBytes[0] >> 4).toString(2).padStart(4, '0');

    const entropyBits = bytesToBits(entropyBytes);
    const combinedBits = entropyBits + checksum;

    const words: string[] = [];
    for (let i = 0; i < combinedBits.length; i += 11) {
        const chunk = combinedBits.slice(i, i + 11);
        const index = parseInt(chunk, 2);
        words.push(WORDLIST_ARRAY[index]);
    }

    return words.join(' ');
}

// Helper to convert hex string to Uint8Array
function hexToBytes(hex: string): Uint8Array {
    const bytes = new Uint8Array(hex.length / 2);
    for (let c = 0; c < hex.length; c += 2) {
        bytes[c / 2] = parseInt(hex.substring(c, c + 2), 16);
    }
    return bytes;
}

// Helper to convert bytes to a binary string
function bytesToBits(bytes: Uint8Array): string {
    let bits = '';
    for (const byte of bytes) {
        bits += byte.toString(2).padStart(8, '0');
    }
    return bits;
}

// Draw entropy visualization
function drawEntropyVisualization() {
    const canvas = document.getElementById('entropyCanvas') as HTMLCanvasElement;
    if (!canvas) return;
    const ctx = canvas.getContext('2d')!;
    
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    
    // Background (clears canvas)
    ctx.fillStyle = '#0a192f';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    if (!currentEntropyHex || currentEntropyHex.length < 16) {
        return; // Wait for entropy
    }

    // Derive parameters from entropy
    const amplitude = (parseInt(currentEntropyHex.substring(0, 4), 16) / 0xFFFF) * (canvas.height / 3) + (canvas.height / 10);
    const frequency1 = 0.02 + (parseInt(currentEntropyHex.substring(4, 8), 16) / 0xFFFF) * 0.05;
    const frequency2 = 0.1 + (parseInt(currentEntropyHex.substring(8, 12), 16) / 0xFFFF) * 0.2;
    const perturbation = parseInt(currentEntropyHex.substring(12, 16), 16) / 0xFFFF;

    const r = 50 + parseInt(currentEntropyHex.substring(0, 2), 16);
    const g = 150 + parseInt(currentEntropyHex.substring(2, 4), 16) / 2;
    const b = 150 + parseInt(currentEntropyHex.substring(4, 6), 16) / 2;
    const lineColor = `rgb(${r}, ${g}, ${b})`;


    // Draw Grid
    ctx.strokeStyle = '#1e3a5f';
    ctx.lineWidth = 0.5;
    for (let x = 0; x < canvas.width; x += 20) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
    }
    for (let y = 0; y < canvas.height; y += 20) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
    }

    // Draw the wave
    ctx.beginPath();
    ctx.lineWidth = 2;
    ctx.strokeStyle = lineColor;
    ctx.shadowColor = lineColor;
    ctx.shadowBlur = 10;

    const time = Date.now() / 500;
    const centerY = canvas.height / 2;

    for (let x = 0; x < canvas.width; x++) {
        // Combine two sine waves for more complexity
        const wave1 = Math.sin(x * frequency1 + time);
        const wave2 = Math.sin(x * frequency2 + time * 0.5);
        // Add a perturbation factor from entropy
        const y = centerY + (wave1 + wave2) * amplitude * (0.8 + perturbation * 0.4);

        if (x === 0) {
            ctx.moveTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    }
    ctx.stroke();
    ctx.shadowBlur = 0; // Reset shadow blur

    // Draw "spark" particles along the wave
    ctx.fillStyle = '#ff9e01';
    for (let i = 0; i < 20; i++) {
        const x = (parseInt(currentEntropyHex.substring(i % 14, (i % 14) + 2), 16) / 0xFF) * canvas.width;
        const wave1 = Math.sin(x * frequency1 + time);
        const wave2 = Math.sin(x * frequency2 + time * 0.5);
        const y = centerY + (wave1 + wave2) * amplitude * (0.8 + perturbation * 0.4);

        ctx.beginPath();
        ctx.arc(x, y, 2, 0, Math.PI * 2);
        ctx.fill();
    }
}

// Initialize and update every second
document.addEventListener('DOMContentLoaded', () => {
    updateValues();
    setInterval(updateValues, 1000);
    setInterval(drawEntropyVisualization, 50);
});

// Handle window resize
window.addEventListener('resize', drawEntropyVisualization);